#!/usr/bin/env bash

# Synopsis:
# Test the track's exercises.
#
# For each exercise we type-check the template solution (which is
# provided to the students) and test if the example solution
# .meta/example.sml passes the tests.
#
# Usage:
# ./bin/test [slug...]

CONTAINER=sml-tests

echo "Checking"

all_slugs="$*"
if [ -z $all_slugs ]; then
  all_slugs=$(ls ./exercises/practice/)
fi

exit_code=0

docker run --rm -dt --entrypoint bash --name $CONTAINER \
       -v $(realpath ./exercises):/exercises:z exercism/sml-test-runner

for slug in $all_slugs; do
  docker exec -it $CONTAINER bash -c "\
    rm -rf /solution &&
    cp -r /exercises/practice/${slug} /solution  &&
    cp /solution/.meta/example.sml /solution/${slug}.sml &&
    bin/run.sh ${slug} /solution /solution"

  results=$(docker exec -it $CONTAINER bash -c "cat /solution/results.json")
  selection=$(echo "$results" | jq -r tostring | grep "{\"version\":1,\"status\":\"pass\"")

  if [ -z $selection ]; then
    echo -e "${slug}: \e[31mFAILED\e[0m\n\n$(echo "$results" | jq -r '.message')\n\n"
    exit_code=1;
  else
    printf "${slug}: \e[32mPASSED\e[0m\n\n";
  fi
done

docker stop $CONTAINER

exit ${exit_code}
